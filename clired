#!/usr/bin/python3

import sys
import urwid
import logging
import getpass
import argparse

from views.IssueView import IssueView
import core.Redmine


logging.basicConfig(filename='clired.log',level=logging.DEBUG)
logger = logging.getLogger(__name__)

#
# Parsing command-line arguments
#
parser = argparse.ArgumentParser(description="Redmine CLI client")
parser.add_argument('issue', type=int, nargs='?')
parser.add_argument('-s', '--server', type=str)
parser.add_argument('-p', '--project', type=str)
parser.add_argument('-u', '--username', type=str)
argv = parser.parse_args()

if argv.issue is None:
    raise Exception("Issue number has to be passed as an argument")

i = core.Redmine.instance().issue(argv.issue)
iv = IssueView(i)

def exit_on_cr(input):
    if iv.key_pressed(input):
        return

    if input == 'q':
        raise urwid.ExitMainLoop()
    logger.debug("Unhandled key pressed: " + str(input))


loop = urwid.MainLoop(iv.get_widget(), None, unhandled_input=exit_on_cr)
loop.run()
print("Good bye!")
